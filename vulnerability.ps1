$Vulnerability_Name = Read-Host -Prompt "Enter Plugin name"
$details = import-csv C:\temp\Detail_List.csv

#$detailgroups = $details | Where-Object {$_."netbios name" -like "*$systemnames*"} | Select-Object * 
#$detailgroups = $details | Group-Object -property "NetBios Name" | Where-Object {$_.count -lt 2} | Select-Object group
$detailgroups = $details | Where-Object {$_."plugin name" -like "*$Vulnerability_Name*"} | Select-Object *
$vulnerabilities = $detailgroups | Select-Object * 
#$vulnerabilities = $detailgroups.group | Select-Object * 
$sccmdevicelists = @()
$sccmdevicelist = @()
$vulnerability = @()
$c1 = 0
#$hostname = @()
foreach ($item in $vulnerabilities){
    $c1++
    Write-Progress -Activity 'Checking systems' -Status "Processing $($c1) of $($vulnerabilities.count)" -CurrentOperation $item."NetBIOS Name" -PercentComplete (($c1/$vulnerabilities.Count) * 100)

    if (($item."netbios name").Length -gt 1) {$parts = $item | Select-Object *, @{Name = 'Hostname'; Expression = {$_."netbios name".Split('\')[1]}}

    $vulnerability += $parts  
    }
    elseif (($item."dns name").Length -gt 1) {$parts = $item | Select-Object *, @{Name = 'Hostname'; Expression = {$_."dns name".Split('.')[0]}}

    $vulnerability += $parts 
    }
}
$vulnerability | export-csv -NoTypeInformation c:\temp\vul.csv
$c1 = 0
foreach ($item in $vulnerability){
    $pluginname = $item."plugin name"
    $c1++
    Write-Progress -Activity 'Pinging Systems' -Status "Processing $($c1) of $($vulnerability.count)" -CurrentOperation $item."NetBIOS Name" -PercentComplete (($c1/$vulnerability.Count) * 100)

    $sccmdevicelist = get-cmdevice -name $item.hostname | Select-Object Name, @{Name = 'PingStatus'; Expression = {(Test-Connection -ComputerName $item.hostname -Quiet -Count 1 -ErrorAction SilentlyContinue)}},`
    @{Name = 'ADUser'; Expression = {(Get-aduser -Identity $_.lastlogonuser).name}}, LastLogonUser, CurrentLogonUser, UserName, PrimaryUser, ADLastLogonTime, @{Name = 'PluginName'; Expression = {$pluginname}}, `
    CNIsOnline, CNLastOfflineTime, CNLastOnlineTime, DeviceOS, DeviceOSBuild, IsActive, LastActiveTime, LastClientCheckTime, LastHardwareScan, LastPolicyRequest, LastSoftwareScan, LastStatusMessage, SerialNumber

    $emailuser = $sccmdevicelist.LastLogonUser + "@llbean.com"
    $fullname = $sccmdevicelist.user
    $pluginname = $item."plugin name"
    $hostname = $item.hostname
#    $output = $item."plugin output"
#    $description = $item.description
    $solution = $item.Solution
    $pluginid = $item.Plugin
    #$ADUser = Get-aduser -Identity $user.split("@")[0] | Select-Object name
    $sccmdevicelists += $sccmdevicelist

} 
$date = get-date -Format "_MMddyy_HHmm"
$sccmdevicelists | export-csv -NoTypeInformation "c:\temp\$Vulnerability_Name$date.csv"
